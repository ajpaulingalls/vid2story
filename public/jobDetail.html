<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Details</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="app-header">
        <div class="title"><a class="brand" href="index.html">Vid2Story</a> <span>Job Details</span></div>
        <nav class="links">
            <a href="jobs.html">Jobs</a>
            <a href="jobStatus.html" id="backLink">Back to Status</a>
        </nav>
    </header>
    <div class="container">
        <h1>Job Details</h1>
        <div id="jobInfo" class="card">
            <h2>Job Information</h2>
            <div id="originalVideoContainer" style="margin-bottom: 20px; display: none;">
                <h3>Original Video</h3>
                <video id="originalVideo" controls style="width: 100%; max-width: 800px; border-radius: 4px;">
                    Your browser does not support the video tag.
                </video>
            </div>
            <p><strong>Job ID:</strong> <span id="jobId"></span></p>
            <p><strong>Status:</strong> <span id="jobStatus" class="status-badge"></span></p>
            <p><strong>Created:</strong> <span id="createdAt"></span></p>
            <p><strong>File:</strong> <span id="fileName"></span></p>
            <p><strong>Duration:</strong> <span id="originalVideoDuration"></span></p>
            <p><strong>Pick Segments:</strong> <span id="pickSegments"></span></p>
            <p><strong>Optimize for Accuracy:</strong> <span id="optimizeForAccuracy"></span></p>
            <p><strong>Use Stack Crop:</strong> <span id="useStackCrop"></span></p>
            <p><strong>Keep Text:</strong> <span id="keepGraphics"></span></p>
            <p><strong>Prioritize Text:</strong> <span id="prioritizeGraphics"></span></p>
            <p><strong>Additional Instructions:</strong> <span id="additionalInstructions"></span></p>
            <p id="progressRow" style="display:none;"></p>
            
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleSection('transcript')">
                    <span><strong>Transcript</strong></span>
                    <span class="toggle-icon" id="transcript-toggle">▶</span>
                </div>
                <div class="collapsible-content" id="transcript-content">
                    <pre id="transcript" class="code-block"></pre>
                </div>
            </div>
            
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleSection('words')">
                    <span><strong>Words Data</strong></span>
                    <span class="toggle-icon" id="words-toggle">▶</span>
                </div>
                <div class="collapsible-content" id="words-content">
                    <pre id="words" class="code-block"></pre>
                </div>
            
            <div class="collapsible-section" id="segments-section" style="display: none;">
                <div class="collapsible-header" onclick="toggleSection('segments')">
                    <span><strong>Segments</strong></span>
                    <span class="toggle-icon" id="segments-toggle">▶</span>
                </div>
                <div class="collapsible-content" id="segments-content">
                    <pre id="segments" class="code-block"></pre>
                </div>
            </div>
        </div>
        
        <h2>Generated Videos</h2>
        <div id="videoList" class="video-list">
            <!-- Videos will be inserted here -->
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        function toggleSection(sectionName) {
            const content = document.getElementById(`${sectionName}-content`);
            const toggle = document.getElementById(`${sectionName}-toggle`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.textContent = '▶';
            } else {
                content.classList.add('expanded');
                toggle.textContent = '▼';
            }
        }
        
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('id');

        async function loadJob() {
            if (!jobId) {
                document.body.innerHTML = '<div class="container"><h1>Error</h1><p>No job ID provided</p></div>';
                return;
            }
            try {
                const response = await fetch(`/api/jobs/${jobId}`);
                const job = await response.json();

                document.getElementById('jobId').textContent = job.id;
                document.getElementById('backLink').href = `jobStatus.html?id=${job.id}`;
                
                // Display original video if available
                const originalVideoContainer = document.getElementById('originalVideoContainer');
                const originalVideo = document.getElementById('originalVideo');
                if (job.originalVideoUrl) {
                    originalVideo.src = job.originalVideoUrl;
                    originalVideoContainer.style.display = 'block';
                } else {
                    originalVideoContainer.style.display = 'none';
                }
                
                const statusEl = document.getElementById('jobStatus');
                statusEl.textContent = formatStatus(job);
                statusEl.className = `status-badge status-${job.status}`;
                document.getElementById('createdAt').textContent = new Date(job.createdAt).toLocaleString();
                document.getElementById('fileName').textContent = job.filePath.split('/').pop();
                if (job.originalVideoDuration) {
                    const minutes = Math.floor(job.originalVideoDuration / 60);
                    const seconds = Math.floor(job.originalVideoDuration % 60);
                    document.getElementById('originalVideoDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')} (${job.originalVideoDuration} seconds)`;
                } else {
                    document.getElementById('originalVideoDuration').textContent = 'Not available';
                }
                let pickSegmentsText = job.pickSegments ? 'Yes' : 'No';
                if (job.pickSegments && job.originalVideoDuration && job.originalVideoDuration < 180) {
                    pickSegmentsText += ' (But the video was less than 3 minutes, so no segments selected)';
                }
                document.getElementById('pickSegments').textContent = pickSegmentsText;
                document.getElementById('optimizeForAccuracy').textContent = job.optimizeForAccuracy ? 'Yes' : 'No';
                document.getElementById('keepGraphics').textContent = job.keepGraphics ? 'Yes' : 'No';
                document.getElementById('useStackCrop').textContent = job.useStackCrop ? 'Yes' : 'No';
                document.getElementById('prioritizeGraphics').textContent = job.prioritizeGraphics ? 'Yes' : 'No';
                document.getElementById('additionalInstructions').textContent = job.additionalInstructions || 'None';
                document.getElementById('transcript').textContent = job.transcript;

                // Apply RTL for Arabic language on relevant containers
                applyRtlIfArabic(job.language, [
                    '.video-list',
                    '#transcript',
                    '#words',
                    '#segments',
                ]);
                if (job.words) {
                    document.getElementById('words').textContent = JSON.stringify(job.words, null, 2);
                } else {
                    document.getElementById('words').textContent = 'No words data available';
                }
                let showSegments = job.pickSegments;
                if (job.originalVideoDuration && job.originalVideoDuration < 180) {
                    showSegments = false;
                }
                if (showSegments) {
                    document.getElementById('segments-section').style.display = '';
                    if (job.segments) {
                        document.getElementById('segments').textContent = JSON.stringify(job.segments, null, 2);
                    } else {
                        document.getElementById('segments').textContent = 'No segments data available';
                    }
                } else {
                    document.getElementById('segments-section').style.display = 'none';
                }

                const { total, clipped, cropped, captioned, finalized } = computeProgress(job);
                const progressRow = document.getElementById('progressRow');
                const showProgress = showSegments && total > 0;
                if (showProgress) {
                    progressRow.style.display = '';
                    progressRow.innerHTML = `<strong>Progress:</strong> Clipped ${clipped}/${total} · Cropped ${cropped}/${total} · Captioned ${captioned}/${total} · Finalized ${finalized}/${total}`;
                } else {
                    progressRow.style.display = 'none';
                }

                const videoList = document.getElementById('videoList');
                videoList.innerHTML = '';
                if (job.videos && job.videos.length > 0) {
                    job.videos.forEach(video => {
                        const status = segmentStatus(video);
                        const videoElement = document.createElement('div');
                        videoElement.className = 'video-item';
                        videoElement.innerHTML = `
                            <div class="video-title">${video.title}</div>
                            <div class="video-description">${video.description}</div>
                            <div class="video-caption"><strong>Caption:</strong> ${video.caption || 'No caption available'}</div>
                            <div class="video-timing">
                                Start: ${video.startTime} - End: ${video.endTime} (Duration: ${computeDurationString(video.startTime, video.endTime)})
                            </div>
                            <div class="video-links">
                                <span class="status-badge" style="margin-right: 8px;">${status}</span>
                                ${showSegments ? (
                                    video.clippedVideoUrl ? 
                                        `<a href="videoDetail.html?id=${video.id}&type=clipped" class="video-link">Clipped</a>` :
                                        `<span class="video-link" style="color: #666;">Clipped - pending</span>`
                                ) : ''}
                                ${video.croppedVideoUrl ? 
                                    `<a href="videoDetail.html?id=${video.id}&type=cropped" class="video-link">Cropped</a>` :
                                    `<span class="video-link" style="color: #666;">Cropped - pending</span>`
                                }
                                ${video.audioVideoUrl ? 
                                    `<a href="videoDetail.html?id=${video.id}&type=audio" class="video-link">Audio</a>` :
                                    ''
                                }
                                ${video.captionVideoUrl ? 
                                    `<a href="videoDetail.html?id=${video.id}&type=caption" class="video-link">Captioned</a>` :
                                    `<span class="video-link" style="color: #666;">Captioned - pending</span>`
                                }
                                ${video.finalVideoUrl ? 
                                    `<a href="videoDetail.html?id=${video.id}&type=final" class="video-link">Final</a>` :
                                    `<span class="video-link" style="color: #666;">Final - pending</span>`
                                }
                            </div>
                        `;
                        videoList.appendChild(videoElement);
                    });
                } else {
                    videoList.innerHTML = '<p>No videos generated yet.</p>';
                }
            } catch (error) {
                document.body.innerHTML = '<div class="container"><h1>Error</h1><p>Failed to load job details</p></div>';
            }
        }

        loadJob();
    </script>
</body>
</html> 