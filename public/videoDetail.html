<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Detail</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="app-header">
        <div class="title"><a class="brand" href="index.html">Vid2Story</a> <span>Video Detail</span></div>
        <nav class="links">
            <a href="jobs.html">Jobs</a>
            <a href="#" id="backLink">Back to Job</a>
        </nav>
    </header>
    <div class="container">
        
        <div class="video-header">
            <h1 class="video-title" id="videoTitle">Loading...</h1>
            <span class="video-type" id="videoType">Video</span>
        </div>
        
        <div id="videoContainer" class="video-container">
            <div class="loading">Loading video...</div>
        </div>
        
        <div class="video-info">
            <h3>Video Information</h3>
            <p><strong>Title:</strong> <span id="videoTitleInfo">Loading...</span></p>
            <p><strong>Description:</strong></p>
            <div class="video-description" id="videoDescription">Loading...</div>
            <p><strong>Caption:</strong></p>
            <div class="video-caption" id="videoCaption">Loading...</div>
            <p><strong>Type:</strong> <span id="videoTypeInfo">Loading...</span></p>
            <p><strong>Start Time:</strong> <span id="videoStartTime">Loading...</span></p>
            <p><strong>End Time:</strong> <span id="videoEndTime">Loading...</span></p>
            <p><strong>Duration:</strong> <span id="videoDuration">Loading...</span></p>
            <p><strong>Created:</strong> <span id="videoCreatedAt">Loading...</span></p>
            <p><strong>Transcript:</strong></p>
            <div class="video-transcript" id="videoTranscript">Loading...</div>
            <p><strong>Video URL:</strong></p>
            <div class="video-url" id="videoUrl">Loading...</div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Get video ID and type from URL
        const urlParams = new URLSearchParams(window.location.search);
        const videoId = urlParams.get('id');
        const videoType = urlParams.get('type') || 'video';
        
        if (!videoId) {
            document.getElementById('videoContainer').innerHTML = 
                '<div class="error-message">No video ID provided</div>';
        } else {
            // Fetch video details by ID
            fetch(`/api/videos/${videoId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Video not found');
                    }
                    return response.json();
                })
                .then(video => {
                    // Update page title and video type
                    const typeDisplayNames = {
                        'clipped': 'Clipped Video',
                        'cropped': 'Cropped Video', 
                        'audio': 'Portrait + Audio',
                        'caption': 'Caption Video',
                        'final': 'Final Video'
                    };
                    const displayType = typeDisplayNames[videoType] || 'Video';
                    
                    document.getElementById('videoTitle').textContent = video.title;
                    document.getElementById('videoType').textContent = displayType;
                    document.getElementById('videoTitleInfo').textContent = video.title;
                    document.getElementById('videoDescription').textContent = video.description;
                    document.getElementById('videoCaption').textContent = video.caption || 'No caption available';
                    document.getElementById('videoTypeInfo').textContent = displayType;
                    document.getElementById('videoStartTime').textContent = video.startTime;
                    document.getElementById('videoEndTime').textContent = video.endTime;
                    document.getElementById('videoCreatedAt').textContent = new Date(video.createdAt).toLocaleString();
                    document.getElementById('videoTranscript').textContent = video.transcript;
                    // Duration
                    const duration = computeDurationString(video.startTime, video.endTime);
                    document.getElementById('videoDuration').textContent = duration;
                    
                    // Set back link to job details
                    document.getElementById('backLink').href = `jobDetail.html?id=${video.jobId}`;

                    // Fetch parent job to read language and apply RTL if needed
                    fetch(`/api/jobs/${video.jobId}`)
                        .then(r => r.ok ? r.json() : null)
                        .then(job => {
                            if (job) {
                                applyRtlIfArabic(job.language, [
                                    document.body,
                                    '#videoContainer',
                                    '.video-info',
                                    '.video-description',
                                    '.video-caption',
                                    '.video-transcript'
                                ]);
                            }
                        })
                        .catch(()=>{});
                    
                    // Determine which video URL to use based on type
                    let videoUrl = '';
                    switch(videoType) {
                        case 'clipped':
                            videoUrl = video.clippedVideoUrl;
                            break;
                        case 'cropped':
                            videoUrl = video.croppedVideoUrl;
                            break;
                        case 'audio':
                            videoUrl = video.audioVideoUrl;
                            break;
                        case 'caption':
                            videoUrl = video.captionVideoUrl;
                            break;
                        case 'final':
                            videoUrl = video.finalVideoUrl;
                            break;
                        default:
                            videoUrl = video.clippedVideoUrl || video.croppedVideoUrl || video.audioVideoUrl || video.captionVideoUrl || video.finalVideoUrl;
                    }
                    
                    if (videoUrl) {
                        document.getElementById('videoUrl').textContent = videoUrl;
                        
                        // Create video player
                        const videoContainer = document.getElementById('videoContainer');
                        videoContainer.innerHTML = `
                            <video class="video-player" controls preload="metadata">
                                <source src="${videoUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        `;
                    } else {
                        document.getElementById('videoContainer').innerHTML = 
                            '<div class="error-message">Video file not available yet</div>';
                        document.getElementById('videoUrl').textContent = 'Not available';
                    }
                })
                .catch(error => {
                    console.error('Error loading video:', error);
                    document.getElementById('videoContainer').innerHTML = 
                        '<div class="error-message">Error loading video. Please check the ID and try again.</div>';
                });
        }
    </script>
</body>
</html>
