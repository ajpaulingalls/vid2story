<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Detail</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="app-header">
        <div class="title"><a class="brand" href="index.html">Vid2Story</a> <span>Video Detail</span></div>
        <nav class="links">
            <a href="jobs.html">Jobs</a>
            <a href="#" id="backLink">Back to Job</a>
        </nav>
    </header>
    <div class="container">
        
        <div class="video-header">
            <h1 class="video-title" id="videoTitle">Loading...</h1>
            <span class="video-type" id="videoType">Video</span>
        </div>
        
        <div id="videoContainer" class="video-container">
            <div class="loading">Loading video...</div>
        </div>
        
        <div class="video-info">
            <h3>Video Information</h3>
            <p><strong>Title:</strong> <span id="videoTitleInfo">Loading...</span></p>
            <p><strong>Description:</strong></p>
            <div class="video-description" id="videoDescription">Loading...</div>
            <p><strong>Caption:</strong></p>
            <div class="video-caption" id="videoCaption">Loading...</div>
            <p><strong>Type:</strong> <span id="videoTypeInfo">Loading...</span></p>
            <p><strong>Start Time:</strong> <span id="videoStartTime">Loading...</span></p>
            <p><strong>End Time:</strong> <span id="videoEndTime">Loading...</span></p>
            <p><strong>Duration:</strong> <span id="videoDuration">Loading...</span></p>
            <p><strong>Created:</strong> <span id="videoCreatedAt">Loading...</span></p>
            <div id="transcriptSection" class="video-transcript-section" hidden>
                <div class="transcript-header">
                    <strong>Transcript:</strong>
                    <button type="button" class="btn btn-secondary" id="editTranscriptBtn">Edit</button>
                </div>
                <div class="video-transcript" id="videoTranscript">Loading...</div>
                <textarea
                    id="videoTranscriptEditor"
                    class="video-transcript-editor"
                    aria-label="Transcript editor"
                    hidden
                ></textarea>
                <div class="transcript-controls">
                    <button type="button" class="btn btn-primary" id="saveTranscriptBtn" hidden disabled>Save</button>
                    <span id="transcriptStatus" class="transcript-status" aria-live="polite"></span>
                </div>
            </div>
            <p><strong>Video URL:</strong></p>
            <div class="video-url" id="videoUrl">Loading...</div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Get video ID and type from URL
        const urlParams = new URLSearchParams(window.location.search);
        const videoId = urlParams.get('id');
        const videoType = urlParams.get('type') || 'video';
        const transcriptTypes = new Set(['caption', 'final']);

        const transcriptSection = document.getElementById('transcriptSection');
        const transcriptDisplay = document.getElementById('videoTranscript');
        const transcriptEditor = document.getElementById('videoTranscriptEditor');
        const editTranscriptBtn = document.getElementById('editTranscriptBtn');
        const saveTranscriptBtn = document.getElementById('saveTranscriptBtn');
        const transcriptStatus = document.getElementById('transcriptStatus');

        let transcriptOriginalValue = '';
        let isTranscriptEditing = false;

        const toggleTranscriptEditor = (showEditor) => {
            if (!transcriptEditor || !transcriptDisplay) return;
            transcriptEditor.hidden = !showEditor;
            transcriptDisplay.hidden = showEditor;
        };

        const setTranscriptStatus = (message = '', variant = 'info') => {
            if (!transcriptStatus) return;
            transcriptStatus.textContent = message;
            transcriptStatus.classList.remove('success', 'error');
            if (!message) return;
            if (variant === 'success') transcriptStatus.classList.add('success');
            if (variant === 'error') transcriptStatus.classList.add('error');
        };

        const exitTranscriptEditMode = (restoreOriginal = true) => {
            if (!transcriptEditor || !transcriptDisplay || !editTranscriptBtn || !saveTranscriptBtn) return;
            isTranscriptEditing = false;
            toggleTranscriptEditor(false);
            editTranscriptBtn.textContent = 'Edit';
            saveTranscriptBtn.hidden = true;
            saveTranscriptBtn.disabled = true;
            saveTranscriptBtn.textContent = 'Save';
            if (restoreOriginal) {
                transcriptEditor.value = transcriptOriginalValue;
                transcriptDisplay.textContent = transcriptOriginalValue || 'No transcript available yet';
                setTranscriptStatus('');
            }
        };

        const enterTranscriptEditMode = () => {
            if (!transcriptEditor || !editTranscriptBtn) return;
            isTranscriptEditing = true;
            toggleTranscriptEditor(true);
            editTranscriptBtn.textContent = 'Cancel';
            setTranscriptStatus('');
            setTimeout(() => transcriptEditor.focus(), 0);
        };

        toggleTranscriptEditor(false);
        
        if (!videoId) {
            document.getElementById('videoContainer').innerHTML = 
                '<div class="error-message">No video ID provided</div>';
        } else {
            // Fetch video details by ID
            fetch(`/api/videos/${videoId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Video not found');
                    }
                    return response.json();
                })
                .then(video => {
                    // Update page title and video type
                    const typeDisplayNames = {
                        'clipped': 'Clipped Video',
                        'cropped': 'Cropped Video', 
                        'audio': 'Portrait + Audio',
                        'caption': 'Caption Video',
                        'final': 'Final Video'
                    };
                    const displayType = typeDisplayNames[videoType] || 'Video';
                    
                    document.getElementById('videoTitle').textContent = video.title;
                    document.getElementById('videoType').textContent = displayType;
                    document.getElementById('videoTitleInfo').textContent = video.title;
                    document.getElementById('videoDescription').textContent = video.description;
                    document.getElementById('videoCaption').textContent = video.caption || 'No caption available';
                    document.getElementById('videoTypeInfo').textContent = displayType;
                    document.getElementById('videoStartTime').textContent = video.startTime;
                    document.getElementById('videoEndTime').textContent = video.endTime;
                    document.getElementById('videoCreatedAt').textContent = new Date(video.createdAt).toLocaleString();
                    transcriptOriginalValue = video.transcript || '';

                    if (transcriptTypes.has(videoType) && transcriptSection) {
                        transcriptSection.hidden = false;
                        const hasTranscript = transcriptOriginalValue.trim().length > 0;
                        transcriptDisplay.textContent = hasTranscript
                            ? transcriptOriginalValue
                            : 'No transcript available yet';
                        transcriptEditor.value = transcriptOriginalValue;
                    } else if (transcriptSection) {
                        transcriptSection.hidden = true;
                    }
                    // Duration
                    const duration = computeDurationString(video.startTime, video.endTime);
                    document.getElementById('videoDuration').textContent = duration;
                    
                    // Set back link to job details
                    document.getElementById('backLink').href = `jobDetail.html?id=${video.jobId}`;

                    // Fetch parent job to read language and apply RTL if needed
                    fetch(`/api/jobs/${video.jobId}`)
                        .then(r => r.ok ? r.json() : null)
                        .then(job => {
                            if (job) {
                                applyRtlIfArabic(job.language, [
                                    document.body,
                                    '#videoContainer',
                                    '.video-info',
                                    '.video-description',
                                    '.video-caption',
                                    '.video-transcript',
                                    '#transcriptSection',
                                    '#videoTranscriptEditor'
                                ]);
                            }
                        })
                        .catch(()=>{});
                    
                    // Determine which video URL to use based on type
                    let videoUrl = '';
                    switch(videoType) {
                        case 'clipped':
                            videoUrl = video.clippedVideoUrl;
                            break;
                        case 'cropped':
                            videoUrl = video.croppedVideoUrl;
                            break;
                        case 'audio':
                            videoUrl = video.audioVideoUrl;
                            break;
                        case 'caption':
                            videoUrl = video.captionVideoUrl;
                            break;
                        case 'final':
                            videoUrl = video.finalVideoUrl;
                            break;
                        default:
                            videoUrl = video.clippedVideoUrl || video.croppedVideoUrl || video.audioVideoUrl || video.captionVideoUrl || video.finalVideoUrl;
                    }
                    
                    if (videoUrl) {
                        document.getElementById('videoUrl').textContent = videoUrl;
                        
                        // Create video player
                        const videoContainer = document.getElementById('videoContainer');
                        videoContainer.innerHTML = `
                            <video class="video-player" controls preload="metadata">
                                <source src="${videoUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        `;
                    } else {
                        document.getElementById('videoContainer').innerHTML = 
                            '<div class="error-message">Video file not available yet</div>';
                        document.getElementById('videoUrl').textContent = 'Not available';
                    }
                })
                .catch(error => {
                    console.error('Error loading video:', error);
                    document.getElementById('videoContainer').innerHTML = 
                        '<div class="error-message">Error loading video. Please check the ID and try again.</div>';
                });

            if (
                transcriptSection &&
                transcriptDisplay &&
                transcriptEditor &&
                editTranscriptBtn &&
                saveTranscriptBtn
            ) {
                editTranscriptBtn.addEventListener('click', () => {
                    if (!transcriptTypes.has(videoType)) return;
                    if (!isTranscriptEditing) {
                        enterTranscriptEditMode();
                    } else {
                        exitTranscriptEditMode(true);
                    }
                });

                transcriptEditor.addEventListener('input', () => {
                    if (!isTranscriptEditing) return;
                    const hasChanges = transcriptEditor.value !== transcriptOriginalValue;
                    saveTranscriptBtn.hidden = !hasChanges;
                    saveTranscriptBtn.disabled = !hasChanges;
                    if (!hasChanges) {
                        setTranscriptStatus('');
                    }
                });

                saveTranscriptBtn.addEventListener('click', async () => {
                    if (!videoId) return;
                    const updatedTranscript = transcriptEditor.value;
                    if (!updatedTranscript.trim()) {
                        setTranscriptStatus('Transcript cannot be empty.', 'error');
                        return;
                    }

                    saveTranscriptBtn.disabled = true;
                    saveTranscriptBtn.textContent = 'Saving...';
                    setTranscriptStatus('Saving transcript and regenerating videos...');

                    try {
                        const response = await fetch(`/api/videos/${videoId}/transcript`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ transcript: updatedTranscript }),
                        });

                        let payload = {};
                        try {
                            payload = await response.json();
                        } catch (parseErr) {
                            payload = {};
                        }

                        if (!response.ok) {
                            throw new Error(payload.error || 'Unable to save transcript');
                        }

                        const nextTranscript = payload.video?.transcript || updatedTranscript;
                        transcriptOriginalValue = nextTranscript;
                        transcriptDisplay.textContent = nextTranscript || 'No transcript available yet';
                        transcriptEditor.value = nextTranscript;
                        setTranscriptStatus('Transcript saved. Videos have been regenerated.', 'success');
                        exitTranscriptEditMode(false);
                        setTimeout(() => window.location.reload(), 1000);
                    } catch (error) {
                        console.error('Error saving transcript:', error);
                        setTranscriptStatus(error.message || 'Failed to save transcript.', 'error');
                        saveTranscriptBtn.disabled = false;
                    } finally {
                        if (saveTranscriptBtn.textContent !== 'Save') {
                            saveTranscriptBtn.textContent = 'Save';
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>
